// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============ ENUMS ============

enum UserRole {
  SUPER_ADMIN
  SALES_REP
  MARKETING_REP
}

enum LeadSource {
  WEBSITE
  REFERRAL
  COLD_CALL
  LINKEDIN
  TRADE_SHOW
  EMAIL_CAMPAIGN
  UPWORK
  GURU
  FREELANCER
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  UNQUALIFIED
}

enum Pipeline {
  IT_SERVICES
  ALL_PRODUCTS
  STAFFING
}

enum DealStage {
  LEAD
  QUALIFIED
  DISCOVERY
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum AmountType {
  FIXED
  HOURLY
  RETAINER
}

enum ActivityType {
  NOTE
  CALL
  MEETING
  EMAIL
}

enum ProductType {
  ONE_TIME
  RECURRING
}

enum AlertType {
  QUOTA_RED
  QUOTA_GREEN
  QUOTA_YELLOW
  STALE_RED
  STALE_YELLOW
  ACTIVITY_RED
  ACTIVITY_GREEN
  TASK_RED
  TASK_YELLOW
  MONTHLY_RED
  MONTHLY_GREEN
  MONTHLY_YELLOW
  MARKETING_RED
  MARKETING_GREEN
  MARKETING_YELLOW
  MARKETING_MONTHLY
}

enum AlertSeverity {
  RED
  YELLOW
  GREEN
}

enum MarketingTaskType {
  LINKEDIN_OUTREACH
  COLD_EMAIL
  SOCIAL_POST
  BLOG_POST
  EMAIL_CAMPAIGN
  EVENT
  WEBINAR
  CONTENT_CREATION
  OTHER
}

enum MarketingTaskStatus {
  IN_PROGRESS
  COMPLETED
  NO_RESPONSE
}

enum MarketingTaskOutcome {
  SUCCESS
  PARTIAL
  FAILED
}

// ============ MODELS ============

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(SALES_REP)
  avatar    String?
  isActive  Boolean  @default(true)
  monthlyQuota Float @default(3000)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leadsOwned      Lead[]               @relation("LeadOwner")
  dealsOwned      Deal[]               @relation("DealOwner")
  activities      Activity[]
  tasks           Task[]
  dealLineItems   DealLineItem[]
  emailLogs       EmailLog[]
  quotas          UserQuota[]
  quotaAlerts     QuotaAlert[]
  marketingTasks  MarketingTask[]
  alertExclusions UserAlertExclusion[]

  @@map("users")
}

model Lead {
  id                String      @id @default(cuid())
  name              String
  email             String?
  phone             String?
  company           String?
  title             String?
  source            LeadSource  @default(OTHER)
  status            LeadStatus  @default(NEW)
  regionTags        String[]    @default([])
  ownerId           String
  owner             User        @relation("LeadOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  convertedToDealId String?     @unique
  convertedToDeal   Deal?       @relation("LeadToDeal", fields: [convertedToDealId], references: [id])
  isConverted       Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  activities Activity[]
  tasks      Task[]

  @@map("leads")
}

model Deal {
  id                  String     @id @default(cuid())
  name                String
  pipeline            Pipeline   @default(IT_SERVICES)
  stage               DealStage  @default(LEAD)
  amountType          AmountType @default(FIXED)
  amountTotal         Float?
  hourlyRate          Float?
  expectedHours       Float?
  probability         Int        @default(0) // 0-100
  closeDate           DateTime?
  source              LeadSource?
  regionTags          String[]   @default([])
  company             String?
  contactEmail        String?
  ownerId             String
  owner               User       @relation("DealOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  convertedFromLeadId String?    @unique
  convertedFromLead   Lead?      @relation("LeadToDeal")
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  lineItems  DealLineItem[]
  activities Activity[]
  tasks      Task[]

  @@map("deals")
}

model Product {
  id          String      @id @default(cuid())
  name        String
  description String?
  category    String
  unitPrice   Float
  type        ProductType @default(ONE_TIME)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  lineItems DealLineItem[]

  @@map("products")
}

model DealLineItem {
  id          String      @id @default(cuid())
  dealId      String
  deal        Deal        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  productId   String?
  product     Product?    @relation(fields: [productId], references: [id], onDelete: SetNull)
  productName String      // denormalized for flexibility
  quantity    Float       @default(1)
  unitPrice   Float
  discount    Float       @default(0)
  type        ProductType @default(ONE_TIME)
  total       Float       // calculated: qty * unitPrice * (1 - discount)
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("deal_line_items")
}

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType @default(NOTE)
  subject     String
  description String?      @db.Text
  leadId      String?
  lead        Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  dealId      String?
  deal        Deal?        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("activities")
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  completed   Boolean   @default(false)
  dueDate     DateTime?
  leadId      String?
  lead        Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  dealId      String?
  deal        Deal?     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("tasks")
}

// ============ QUOTA & EMAIL MONITORING ============

model EmailLog {
  id           String        @id @default(cuid())
  alertType    AlertType
  severity     AlertSeverity
  userId       String
  user         User          @relation(fields: [userId], references: [id])
  recipientTo  String
  recipientsCc String[]      @default([])
  subject      String
  body         String        @db.Text
  sesMessageId String?
  sentAt       DateTime      @default(now())
  quotaTarget  Float?
  quotaActual  Float?
  period       String?

  @@index([userId])
  @@index([alertType])
  @@index([sentAt])
  @@map("email_logs")
}

model UserQuota {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  year         Int
  month        Int
  targetAmount Float    @default(3000)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, year, month])
  @@index([userId])
  @@map("user_quotas")
}

model QuotaAlert {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  alertType AlertType
  severity  AlertSeverity
  period    String
  sentAt    DateTime      @default(now())

  @@unique([userId, alertType, period])
  @@index([userId])
  @@map("quota_alerts")
}

// ============ ALERT CONFIGURATION ============

enum AlertCategory {
  QUOTA
  STALE
  ACTIVITY
  TASK
  MARKETING
  MONTHLY
}

model AlertConfig {
  id              String        @id @default(cuid())
  alertCategory   AlertCategory
  enabled         Boolean       @default(true)
  schedule        String        @default("0 9 * * 1-5") // cron format, default 9am Mon-Fri
  redThreshold    Float?        // e.g., <50% for quota, >14 days for stale
  yellowThreshold Float?        // e.g., <80% for quota, >7 days for stale
  greenThreshold  Float?        // e.g., >=100% for quota
  ccRecipients    String[]      @default([])
  bccAdmin        Boolean       @default(false)
  testMode        Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([alertCategory])
  @@map("alert_configs")
}

model GlobalAlertSettings {
  id              String   @id @default(cuid())
  fromEmail       String   @default("alerts@forge-crm.com")
  bccAllToAdmin   Boolean  @default(false)
  adminEmail      String   @default("admin@forge-crm.com")
  testMode        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("global_alert_settings")
}

model UserAlertExclusion {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime
  reason      String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([startDate, endDate])
  @@map("user_alert_exclusions")
}

// ============ MARKETING TASKS ============

model MarketingTask {
  id            String                 @id @default(cuid())
  type          MarketingTaskType
  description   String
  target        String?
  content       String?                @db.Text
  taskDate      DateTime               @default(now())
  status        MarketingTaskStatus    @default(IN_PROGRESS)
  outcome       MarketingTaskOutcome?
  resultNotes   String?                @db.Text
  leadGenerated Boolean                @default(false)
  generatedLeadId String?
  isTemplate    Boolean                @default(false)
  templateName  String?
  templateId    String?
  template      MarketingTask?         @relation("TaskTemplate", fields: [templateId], references: [id])
  tasksFromTemplate MarketingTask[]    @relation("TaskTemplate")
  userId        String
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([taskDate])
  @@map("marketing_tasks")
}

